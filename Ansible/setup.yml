---
- name: Настройка базовых пакетов на всех хостах
  hosts: all
  become: yes
  tasks:
    - name: Обновление пакетов
      apt:
        update_cache: yes
        upgrade: dist

    - name: Установка базовых утилит
      apt:
        name:
          - curl
          - wget
          - vim
          - net-tools
          - htop
        state: present

- name: Настройка веб-серверов
  hosts: web_servers
  become: yes
  tasks:
    - name: Установка nginx
      apt:
        name: nginx
        state: present
    
    - name: Создание index.html
      copy:
        dest: /var/www/html/index.html
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>Web Server</title>
          </head>
          <body>
              <h1>Web Server: {{ inventory_hostname }}</h1>
              <p>Private IP: {{ ansible_default_ipv4.address }}</p>
              <p>Hostname: {{ ansible_hostname }}</p>
          </body>
          </html>
    
    - name: Запуск nginx
      service:
        name: nginx
        state: started
        enabled: yes

- name: Настройка Zabbix
  hosts: monitoring
  become: yes
  tasks:
    - name: Установка зависимостей
      apt:
        name:
          - postgresql
          - apache2
          - php
          - php-pgsql
          - libapache2-mod-php
          - wget
        state: present
    
    - name: Добавление репозитория Zabbix (через команды)
      shell: |
        wget -O /tmp/zabbix-release.deb https://repo.zabbix.com/zabbix/6.4/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.4-1+ubuntu22.04_all.deb
        dpkg -i /tmp/zabbix-release.deb
        apt update
      args:
        creates: /etc/apt/sources.list.d/zabbix.list
    
    - name: Установка Zabbix
      apt:
        name:
          - zabbix-server-pgsql
          - zabbix-frontend-php
          - zabbix-agent
        state: present
    
    - name: Настройка PostgreSQL для Zabbix
      shell: |
        # Создаем пользователя и базу через sudo
        sudo -u postgres psql -c "CREATE USER zabbix WITH PASSWORD 'zabbix';" 2>/dev/null || echo "User already exists"
        sudo -u postgres createdb -O zabbix zabbix 2>/dev/null || echo "Database already exists"
        
        # Ищем и импортируем SQL скрипты
        SQL_FILE=$(find /usr/share -name "*.sql.gz" -type f | grep -i postgresql | head -1)
        if [ -n "$SQL_FILE" ]; then
          echo "Importing schema from $SQL_FILE"
          zcat "$SQL_FILE" | sudo -u zabbix psql zabbix 2>/dev/null || true
        fi
      changed_when: false
    
    - name: Конфигурация Zabbix Server
      shell: |
        sed -i "s/^# DBPassword=.*/DBPassword=zabbix/" /etc/zabbix/zabbix_server.conf
        sed -i "s/^# DBHost=.*/DBHost=localhost/" /etc/zabbix/zabbix_server.conf
    
    - name: Конфигурация Zabbix Agent
      shell: |
        sed -i "s/^Server=127.0.0.1$/Server=127.0.0.1/" /etc/zabbix/zabbix_agentd.conf
        sed -i "s/^ServerActive=127.0.0.1$/ServerActive=127.0.0.1/" /etc/zabbix/zabbix_agentd.conf
        echo "Hostname=zabbix-server" >> /etc/zabbix/zabbix_agentd.conf
    
    - name: Конфигурация PHP
      shell: |
        sed -i "s/^;date.timezone =.*/date.timezone = Europe\/Moscow/" /etc/php/8.1/apache2/php.ini
        sed -i "s/^;max_execution_time =.*/max_execution_time = 300/" /etc/php/8.1/apache2/php.ini
        sed -i "s/^;memory_limit =.*/memory_limit = 256M/" /etc/php/8.1/apache2/php.ini
    
    - name: Настройка Apache для Zabbix
      shell: |
        # Создаем конфиг для Zabbix
        cat > /etc/apache2/sites-available/zabbix.conf << EOF
        <VirtualHost *:80>
            DocumentRoot /usr/share/zabbix
            <Directory /usr/share/zabbix>
                Options FollowSymLinks
                AllowOverride None
                Require all granted
            </Directory>
        </VirtualHost>
        EOF
        
        # Отключаем default сайт, включаем Zabbix
        a2dissite 000-default.conf
        a2ensite zabbix.conf
    
    - name: Запуск сервисов
      systemd:
        name: "{{ item }}"
        state: restarted
        enabled: yes
      loop:
        - postgresql
        - zabbix-server
        - zabbix-agent
        - apache2



- name: Быстрая настройка Elasticsearch
  hosts: elasticsearch
  become: yes
  tasks:
    - name: Установка Java 17
      apt:
        name: openjdk-17-jdk
        state: present
    
    - name: Сброс Elasticsearch
      shell: |
        sudo systemctl stop elasticsearch 2>/dev/null || true
        sudo apt remove --purge -y elasticsearch 2>/dev/null || true
        
        # Установка Elasticsearch 8.x
        wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
        echo "deb https://artifacts.elastic.co/packages/8.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-8.x.list
        apt update
        apt install -y elasticsearch
        
        # Минимальная конфигурация
        cat > /etc/elasticsearch/elasticsearch.yml << 'EOF'
        cluster.name: my-cluster
        node.name: node-1
        network.host: 0.0.0.0
        discovery.type: single-node
        xpack.security.enabled: false
        xpack.security.enrollment.enabled: false
        xpack.security.http.ssl.enabled: false
        xpack.security.transport.ssl.enabled: false
        EOF
        
        # Минимальные JVM настройки
        echo "-Xms256m" > /etc/elasticsearch/jvm.options
        echo "-Xmx256m" >> /etc/elasticsearch/jvm.options
        echo "-XX:+UseG1GC" >> /etc/elasticsearch/jvm.options
        
        sudo systemctl daemon-reload
        sudo systemctl enable elasticsearch
        sudo systemctl start elasticsearch
        
        sleep 10
        curl http://localhost:9200/
      args:
        executable: /bin/bash
      changed_when: false







- name: Настройка Kibana
  hosts: kibana
  become: yes
  tasks:
    - name: Установка Java
      apt:
        name: openjdk-11-jdk
        state: present
    
    - name: Установка Kibana 7.x
      shell: |
        # Скачиваем Kibana 7.x
        wget https://artifacts.elastic.co/downloads/kibana/kibana-7.17.17-amd64.deb -O /tmp/kibana.deb
        sudo dpkg -i /tmp/kibana.deb || sudo apt-get install -f -y
    
    - name: Настройка Kibana
      copy:
        dest: /etc/kibana/kibana.yml
        content: |
          server.port: 5601
          server.host: "0.0.0.0"
          server.name: "kibana"
          elasticsearch.hosts: ["http://10.130.0.22:9200"]
          elasticsearch.username: ""
          elasticsearch.password: ""
          xpack.security.enabled: false
          xpack.reporting.enabled: false
          xpack.spaces.enabled: false
          monitoring.ui.container.elasticsearch.enabled: false
          elasticsearch.requestTimeout: 30000
          elasticsearch.shardTimeout: 30000
    
    - name: Запуск Kibana
      systemd:
        name: kibana
        state: started
        enabled: yes
    
    - name: Ожидание запуска Kibana
      wait_for:
        port: 5601
        delay: 10
        timeout: 120
